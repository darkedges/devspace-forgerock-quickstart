---
# Source: helm-frds/templates/directory/directory-serviceaccount-frds.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: development-frds-frds-ds
  namespace: dfq
  labels:
    helm.sh/chart: helm-frds-1.0.17
    app.kubernetes.io/name: development-frds-frds-ds
    app.kubernetes.io/instance: development-frds
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/part-of: development-frds-frds-ds
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: frds
automountServiceAccountToken: true
---
# Source: helm-frds/templates/directory/directory-secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: development-frds-frds-ds-secrets
  namespace: dfq
  labels:
    helm.sh/chart: helm-frds-1.0.17
    app.kubernetes.io/name: development-frds-frds-ds
    app.kubernetes.io/instance: development-frds
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/part-of: development-frds-frds-ds
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: frds
type: Opaque
data:
  ROOT_USER_PASSWORD: UGFzc3cwcmQ=
  MONITOR_USER_PASSWORD: UGFzc3cwcmQ=
  DEPLOYMENT_KEY: QUt0bnZJeXdlWmRkWElBMmpMNGhxNkY1Qm43QzFRNUNCVk4xYmtWRGZ2UEJ5UUxQcnRfMW1Kdw==
  DEPLOYMENT_KEY_PASSWORD: UGFzc3cwcmQ=
  jksPassword: Y2hhbmdlaXQ=
---
# Source: helm-frds/templates/directory/directory-configmap-container.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: development-frds-frds-ds-config
  namespace: dfq
  labels:
    helm.sh/chart: helm-frds-1.0.17
    app.kubernetes.io/name: development-frds-frds-ds
    app.kubernetes.io/instance: development-frds
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/part-of: development-frds-frds-ds
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: frds
data:
  DS_BOOTSTRAP_REPLICATION_SERVERS: development-frds-frds-ds-0.development-frds-frds-ds:8989
  DS_GROUP_ID: DE
---
# Source: helm-frds/templates/directory/directory-configmap-dsconfig.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: development-frds-frds-ds-dsconfig
  namespace: dfq
  labels:
    helm.sh/chart: helm-frds-1.0.17
    app.kubernetes.io/name: development-frds-frds-ds
    app.kubernetes.io/instance: development-frds
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/part-of: development-frds-frds-ds
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: frds
data:
  setup.dsconfig:  |
    set-backend-prop --backend-name ${AMCTS_BACKEND_NAME} --set confidentiality-enabled:false
    set-backend-prop --backend-name ${AMCONFIG_BACKEND_NAME} --set confidentiality-enabled:false
    set-backend-prop --backend-name ${AMIDENTITYSTORE_BACKEND_NAME} --set confidentiality-enabled:false
    set-password-policy-prop --policy-name "Default Password Policy" --set require-secure-authentication:false --set "require-secure-password-changes:false"
    set-password-policy-prop --policy-name "Root Password Policy" --set require-secure-authentication:false --set "require-secure-password-changes:false"
  replication.dsconfig:  |
    create-trust-manager-provider --set enabled:true --type blind --provider-name BTM
    set-synchronization-provider-prop --provider-name "Multimaster synchronization" --add trust-manager-provider:BTM --remove trust-manager-provider:PKCS12
---
# Source: helm-frds/templates/directory/directory-configmap-init.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: development-frds-frds-ds-init-config
  namespace: dfq
  labels:
    helm.sh/chart: helm-frds-1.0.17
    app.kubernetes.io/name: development-frds-frds-ds
    app.kubernetes.io/instance: development-frds
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/part-of: development-frds-frds-ds
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: frds
data:
  INIT_INSTANCE_PROFILE: directory
  DS_BOOTSTRAP_REPLICATION_SERVERS: development-frds-frds-ds-0.development-frds-frds-ds:8989
---
# Source: helm-frds/templates/directory/directory-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: development-frds-frds-ds
  namespace: dfq
  labels:
    helm.sh/chart: helm-frds-1.0.17
    app.kubernetes.io/name: development-frds-frds-ds
    app.kubernetes.io/instance: development-frds
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/part-of: development-frds-frds-ds
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: frds
spec:
  clusterIP: None
  selector:
    app.kubernetes.io/name: development-frds-frds-ds
    app.kubernetes.io/instance: development-frds
    app.kubernetes.io/component: development-frds-frds-ds
  ports:
    - name: tcp-admin
      port: 4444
    - name: tcp-replication
      port: 8989
    - name: tcp-ldap
      port: 1389
    - name: tcp-ldaps
      port: 1636
    - name: tcp-https
      port: 8443
---
# Source: helm-frds/templates/directory/directory-statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: development-frds-frds-ds
  namespace: dfq
  labels:
    helm.sh/chart: helm-frds-1.0.17
    app.kubernetes.io/name: development-frds-frds-ds
    app.kubernetes.io/instance: development-frds
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/part-of: development-frds-frds-ds
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: development-frds-frds-ds
spec:
  podManagementPolicy: OrderedReady 
  selector:
    matchLabels:
      app.kubernetes.io/name: development-frds-frds-ds
      app.kubernetes.io/instance: development-frds
      app.kubernetes.io/component: development-frds-frds-ds
  replicas: 1
  revisionHistoryLimit: 10
  minReadySeconds: 0
  serviceName: development-frds-frds-ds
  persistentVolumeClaimRetentionPolicy:
    whenDeleted: Delete
    whenScaled: 
  template:
    metadata:
      labels:
        app.kubernetes.io/name: development-frds-frds-ds
        app.kubernetes.io/instance: development-frds
        app.kubernetes.io/component: development-frds-frds-ds
      annotations:
        checksum/config: f07dc22ac749a7c8ac3f303c456122612b3ec3fef8d6c98baf608fb84d235d98
    spec:
      dnsPolicy: ClusterFirst
      nodeSelector: 
        kubernetes.io/os: linux
      serviceAccountName: default
      terminationGracePeriodSeconds: 300
      subdomain: directory
      initContainers:
      - name: wait-for-first
        image: opsfleet/depends-on
        imagePullPolicy: IfNotPresent
        args:
      - name: init
        image: devspace-forgerock-quickstart/ds:7.5.0
        imagePullPolicy: IfNotPresent
        envFrom:
        - secretRef:
            name: development-frds-frds-ds-secrets
        - configMapRef:
            name: development-frds-frds-ds-init-config
        command:
          - ./docker-entrypoint.sh
          - init
        volumeMounts:
          - mountPath: /opt/frds/instance/data
            name: development-frds-frds-ds-data-volume
          - mountPath: /opt/frds/instance/init/dsconfig
            name: development-frds-frds-ds-dsconfig
      containers:
      - name: frds
        image: devspace-forgerock-quickstart/ds:7.5.0
        imagePullPolicy: IfNotPresent
        lifecycle: 
            preStop:
              exec:
                command:
                - /opt/frds/docker-entrypoint.sh
                - stop
        securityContext: 
            capabilities:
              drop:
              - ALL
              add:
              - NET_BIND_SERVICE
            runAsUser: 11111
            allowPrivilegeEscalation: true
        env:
        - name: DS_ADVERTISED_LISTEN_ADDRESS
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: DS_SERVER_ID
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        envFrom:
        - configMapRef:
            name: development-frds-frds-ds-config
        ports:
        - containerPort: 4444
        - containerPort: 8989
        - containerPort: 1389
        - containerPort: 1636
        - containerPort: 8443
        volumeMounts:
          - mountPath: /opt/frds/instance/data
            name: development-frds-frds-ds-data-volume
        livenessProbe: 
            failureThreshold: 5
            initialDelaySeconds: 10
            periodSeconds: 10
            successThreshold: 1
            tcpSocket:
              port: 1636
            timeoutSeconds: 1
        readinessProbe: 
            failureThreshold: 3
            initialDelaySeconds: 10
            periodSeconds: 10
            successThreshold: 1
            tcpSocket:
              port: 1636
            timeoutSeconds: 1
        resources: 
            requests:
              cpu: 100m
              memory: 90Mi
      volumes:
        - name: development-frds-frds-ds-dsconfig
          configMap:
            name: development-frds-frds-ds-dsconfig
  volumeClaimTemplates:
  - metadata:
      name: development-frds-frds-ds-data-volume
    spec:
      accessModes:
        - ReadWriteOnce
      resources:
        requests:
          storage: 100Mi
